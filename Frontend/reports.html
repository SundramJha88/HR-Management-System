<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - VAAU Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="layoutContainer"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Reports</h1>
      <p>View system reports and analytics</p>
    </div>

    <div class="report-tabs">
      <button class="tab-btn active" onclick="switchTab('attendance')">Attendance Report</button>
      <button class="tab-btn" onclick="switchTab('leave')">Leave Report</button>
    </div>

    <div id="attendanceTab" class="tab-content active">
      <h3>Attendance Report</h3>
      <div class="users-table-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Employee Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
            <tr><td colspan="5" style="text-align:center;padding:20px;">Loading attendance data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="leaveTab" class="tab-content">
      <h3>Leave Report</h3>
      <div class="users-table-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Employee Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Date</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="leaveTableBody">
            <tr><td colspan="5" style="text-align:center;padding:20px;">Loading leave data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    const loadLayout = async () => {
      const res = await fetch('layout.html');
      const html = await res.text();
      document.getElementById('layoutContainer').innerHTML = html;
      window.dispatchEvent(new Event('layoutLoaded'));
    };

    const switchTab = (tab) => {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      event.target.classList.add('active');
    };

    const loadAttendanceReport = async () => {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('http://localhost:5000/admin/attendance-report', {
          headers: { 'auth-token': token }
        });
        const data = await res.json();
        const tbody = document.getElementById('attendanceTableBody');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No attendance records found</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(record => {
          const userName = record.userId?.name || 'Unknown';
          const userEmail = record.userId?.email || 'N/A';
          const userRole = record.userId?.role || 'N/A';
          const date = new Date(record.date).toLocaleDateString() || record.date;
          const status = record.status || 'Present';
          return `
            <tr>
              <td>${userName}</td>
              <td>${userEmail}</td>
              <td><span class="badge">${userRole}</span></td>
              <td>${date}</td>
              <td><span class="badge success">${status}</span></td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        console.error('Attendance report error:', e);
        document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;">Failed to load attendance data</td></tr>';
      }
    };

    const loadLeaveReport = async () => {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('http://localhost:5000/admin/leave-report', {
          headers: { 'auth-token': token }
        });
        const data = await res.json();
        const tbody = document.getElementById('leaveTableBody');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No leave records found</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(record => {
          const userName = record.userId?.name || 'Unknown';
          const userEmail = record.userId?.email || 'N/A';
          const userRole = record.userId?.role || 'N/A';
          const date = new Date(record.date).toLocaleDateString() || record.date;
          const reason = record.reason || 'N/A';
          return `
            <tr>
              <td>${userName}</td>
              <td>${userEmail}</td>
              <td><span class="badge">${userRole}</span></td>
              <td>${date}</td>
              <td>${reason}</td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        console.error('Leave report error:', e);
        document.getElementById('leaveTableBody').innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;">Failed to load leave data</td></tr>';
      }
    };

    loadLayout();
    setTimeout(() => {
      loadAttendanceReport();
      loadLeaveReport();
    }, 500);
  </script>
</body>
</html>
