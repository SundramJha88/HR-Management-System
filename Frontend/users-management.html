<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users Management - VAAU Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="layoutContainer"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Users Management</h1>
      <p>Manage all employees and HR staff</p>
    </div>

    <div class="management-toolbar">
      <input type="text" id="searchBox" placeholder="Search by name or email..." class="search-input">
      <select id="roleFilter" class="filter-select">
        <option value="">All Roles</option>
        <option value="employee">Employee</option>
        <option value="hr">HR</option>
        <option value="admin">Admin</option>
        <option value="manager">Manager</option>
        <option value="supervisor">Supervisor</option>
      </select>
    </div>

    <div class="users-table-wrapper">
      <table class="users-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr><td colspan="5" style="text-align:center;padding:20px;">Loading users...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="editUserModal" class="modal">
      <div class="modal-box">
        <h3>Edit User</h3>
        <label>Name</label>
        <input type="text" id="editName" placeholder="Full name">
        
        <label>Email</label>
        <input type="email" id="editEmail" placeholder="Email address" disabled>
        
        <label>Role</label>
        <select id="editRole">
          <option value="employee">Employee</option>
          <option value="hr">HR</option>
          <option value="admin">Admin</option>
          <option value="manager">Manager</option>
          <option value="supervisor">Supervisor</option>
        </select>
        
        <label>Department</label>
        <input type="text" id="editDepartment" placeholder="Department">
        
        <div class="modal-actions">
          <button class="btn ghost" onclick="closeEditModal()">Cancel</button>
          <button class="btn primary" onclick="saveUserChanges()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let allUsers = [];
    let editingUserId = null;

    const loadLayout = async () => {
      const res = await fetch('layout.html');
      const html = await res.text();
      document.getElementById('layoutContainer').innerHTML = html;
      window.dispatchEvent(new Event('layoutLoaded'));
    };

    const loadUsers = async () => {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('http://localhost:5000/admin/users', {
          headers: { 'auth-token': token }
        });
        allUsers = await res.json();
        displayUsers(allUsers);
      } catch (e) {
        console.error('Users load failed', e);
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;">Failed to load users</td></tr>';
      }
    };

    const displayUsers = (users) => {
      const tbody = document.getElementById('usersTableBody');
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">No users found</td></tr>';
        return;
      }
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${(user.name || 'N/A').replace(/'/g, "&apos;")}</td>
          <td>${(user.email || 'N/A').replace(/'/g, "&apos;")}</td>
          <td><span class="badge">${user.role || 'N/A'}</span></td>
          <td>${(user.department || 'N/A').replace(/'/g, "&apos;")}</td>
          <td>
            <button class="btn small" onclick="openEditModal('${user._id}', '${(user.name || '').replace(/'/g, "&apos;")}', '${(user.email || '').replace(/'/g, "&apos;")}', '${user.role || 'employee'}', '${(user.department || '').replace(/'/g, "&apos;")}')">Edit</button>
            <button class="btn small danger" onclick="deleteUser('${user._id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    };

    const openEditModal = (id, name, email, role, department) => {
      editingUserId = id;
      document.getElementById('editName').value = name;
      document.getElementById('editEmail').value = email;
      document.getElementById('editRole').value = role;
      document.getElementById('editDepartment').value = department;
      document.getElementById('editUserModal').classList.add('show');
    };

    const closeEditModal = () => {
      document.getElementById('editUserModal').classList.remove('show');
    };

    const saveUserChanges = async () => {
      const name = document.getElementById('editName').value;
      const role = document.getElementById('editRole').value;
      const department = document.getElementById('editDepartment').value;

      if (!name || !role) {
        alert('Name and role are required');
        return;
      }

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`http://localhost:5000/admin/users/${editingUserId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'auth-token': token
          },
          body: JSON.stringify({ name, role, department })
        });
        if (res.ok) {
          alert('User updated successfully');
          closeEditModal();
          loadUsers();
        } else {
          alert('Failed to update user');
        }
      } catch (e) {
        console.error(e);
        alert('Error updating user');
      }
    };

    const deleteUser = async (id) => {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`http://localhost:5000/admin/users/${id}`, {
          method: 'DELETE',
          headers: { 'auth-token': token }
        });
        if (res.ok) {
          alert('User deleted successfully');
          loadUsers();
        } else {
          alert('Failed to delete user');
        }
      } catch (e) {
        console.error(e);
        alert('Error deleting user');
      }
    };

    document.getElementById('searchBox').addEventListener('keyup', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allUsers.filter(u => 
        u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query)
      );
      displayUsers(filtered);
    });

    document.getElementById('roleFilter').addEventListener('change', (e) => {
      const role = e.target.value;
      const filtered = role ? allUsers.filter(u => u.role === role) : allUsers;
      displayUsers(filtered);
    });

    document.getElementById('editUserModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('editUserModal')) closeEditModal();
    });

    loadLayout();
    setTimeout(loadUsers, 500);
  </script>
</body>
</html>
