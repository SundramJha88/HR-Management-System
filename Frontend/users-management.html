<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users Management - VAAU Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="layoutContainer"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Users Management</h1>
      <p>Manage employees and HR status</p>
    </div>

    <div class="management-toolbar">
      <input id="searchInput" class="search-input" placeholder="Search by name or email" />
      <select id="roleFilter" class="filter-select">
        <option value="">All Roles</option>
        <option value="employee">Employee</option>
        <option value="hr">HR</option>
        <option value="admin">Admin</option>
      </select>
    </div>

    <div class="users-table-wrapper">
      <table class="users-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Employee ID</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr><td colspan="6" style="text-align:center;padding:20px;">Loading users...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    const token = sessionStorage.getItem('token');
    const loadLayout = async () => {
      const res = await fetch('layout.html');
      const html = await res.text();
      document.getElementById('layoutContainer').innerHTML = html;
      window.dispatchEvent(new Event('layoutLoaded'));
    };

    const state = { users: [] };

    const fetchUsers = async () => {
      const res = await fetch('http://localhost:5000/admin/users', {
        headers: { 'auth-token': token }
      });
      const data = await res.json();
      state.users = Array.isArray(data) ? data : [];
      renderTable();
    };

    const matchFilter = (user) => {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const rf = document.getElementById('roleFilter').value;
      const byRole = !rf || String(user.role).toLowerCase() === rf;
      const byQuery = !q || (String(user.name).toLowerCase().includes(q) || String(user.email || '').toLowerCase().includes(q) || String(user.employeeId || '').toLowerCase().includes(q));
      return byRole && byQuery;
    };

    const renderTable = () => {
      const tbody = document.getElementById('usersTableBody');
      const users = state.users.filter(matchFilter);
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No users found</td></tr>';
        return;
      }
      tbody.innerHTML = users.map(u => {
        const role = String(u.role || '').toLowerCase();
        const idCell = u.employeeId || '';
        const statusCell = u.active === false ? '<span class="badge">Inactive</span>' : '<span class="badge success">Active</span>';
        const isAdmin = role === 'admin';
        const btnText = u.active === false ? 'Activate' : 'Deactivate';
        const disabledAttr = isAdmin ? 'disabled' : '';
        return `
          <tr data-id="${u._id}">
            <td>${u.name}</td>
            <td>${u.email || ''}</td>
            <td><span class="badge">${role}</span></td>
            <td>${idCell}</td>
            <td>${statusCell}</td>
            <td>
              <button class="btn small outline toggle-status" ${disabledAttr}>${btnText}</button>
              <a class="btn small" href="newhire.html?employeeId=${u.employeeId || ''}">Edit</a>
            </td>
          </tr>
        `;
      }).join('');
    };

    const setStatus = async (userId, active) => {
      const res = await fetch(`http://localhost:5000/admin/users/${userId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'auth-token': token },
        body: JSON.stringify({ active })
      });
      const data = await res.json();
      if (data && data.id) {
        state.users = state.users.map(u => u._id === userId ? { ...u, active } : u);
        renderTable();
      } else {
        alert('Failed to update status');
      }
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle-status');
      if (!btn) return;
      const tr = btn.closest('tr');
      const userId = tr.getAttribute('data-id');
      const user = state.users.find(u => u._id === userId);
      if (!user) return;
      const next = user.active === false ? true : false;
      setStatus(userId, next);
    });

    document.getElementById('searchInput').addEventListener('input', renderTable);
    document.getElementById('roleFilter').addEventListener('change', renderTable);

    loadLayout();
    fetchUsers();
  </script>
</body>
</html>
